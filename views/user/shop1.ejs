<%- include("../../views/partials/user/header.ejs") %>
  <style>
    /* Base styles remain unchanged */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .shop-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-bar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .search-form {
      display: flex;
      align-items: center;
      background-color: #f8c8dc;
      border-radius: 25px;
      overflow: hidden;
      max-width: 250px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .search-input {
      flex: 1;
      padding: 8px 10px;
      font-size: 14px;
      border: none;
      outline: none;
      background-color: transparent;
      width: 100%;
    }

    .search-button {
      padding: 8px 15px;
      background-color: #ff69b4;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 15px;
      margin-right: 5px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .search-button:hover {
      background-color: #d14792;
      transform: scale(1.05);
    }

    .clear-button {
      margin-top: -1px;
      padding: 8px 15px;
      background-color: #ff99cc;
      border: 1px solid #ddd;
      border-radius: 15px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      margin-left: 15px;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
    }

    .clear-button:hover {
      background-color: #ff69b4;
      color: #fff;
      transform: scale(1.05);
    }

    .sort-container {
      position: relative;
      display: inline-block;
    }

    .sort-button {
      padding: 8px 20px;
      background-color: #f8c8dc;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
      box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
    }

    .sort-button:hover {
      background-color: #ff69b4;
      color: #fff;
    }

    .sort-button::after {
      content: 'â–¼';
      font-size: 10px;
      margin-left: 5px;
    }

    .sort-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 150px;
    }

    .sort-dropdown.show {
      display: block;
    }

    .sort-option {
      padding: 10px 15px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .sort-option:hover {
      background-color: #f8c8dc;
    }

    .sort-select-hidden {
      display: none;
    }

    .sidebar {
      padding: 20px;
      border: 1px solid #ddd;
      background-color: #ffe4e1;
      border-radius: 8px;
      margin-bottom: 20px;
      width: 250px;
      text-align: center;
      box-sizing: border-box;
    }

    .filter-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 16px;
      color: #d14792;
    }

    .product-list-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .product-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      width: calc(100% - 270px);
    }

    .product-card {
      width: calc(33.333% - 20px);
      height: 430px;
      min-height: 430px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      position: relative;
      background-color: #ffebf0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .product-card img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      object-fit: cover;
    }

    .wishlist-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background-color: rgba(237, 247, 247, 0.8);
      color: #ff1493;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
    }

    .add-to-cart-btn {
      background-color: #ff69b4;
      color: #fff;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin-top: auto;
      transition: background-color 0.3s;
    }

    .add-to-cart-btn:hover {
      background-color: #d14792;
    }

    .pagination {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }

    .pagination a {
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      color: #333;
      text-decoration: none;
      border-radius: 4px;
    }

    .pagination .active {
      background-color: #ff69b4;
      color: #fff;
    }

    .price-filter {
      padding: 10px;
      background-color: #ffe4e1;
      border-radius: 8px;
      margin-top: 20px;
    }

    .price-button {
      padding: 12px 20px;
      background-color: #f8c8dc;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 30px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      text-align: center;
      font-size: 14px;
      margin: 5px;
      width: 90%;
    }

    .price-button:hover {
      background-color: #ff69b4;
      color: white;
      transform: scale(1.05);
    }

    .bi-heart-fill {
      color: #ec93c4;
    }

    .bi-heart-fill:hover {
      color: #f6144d;
    }

    .breadcrumb {
      background-color: #f8c8dc;
      padding: 15px;
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .breadcrumb a {
      color: #d14792;
      text-decoration: none;
    }

    .breadcrumb span {
      color: #888;
    }

    .filter-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .filter-section .filter-item {
      margin: 8px 0;
    }

    .filter-section .filter-item a {
      display: block;
      padding: 8px 12px;
      background-color: #f8c8dc;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }

    .filter-section .filter-item a:hover {
      background-color: #ff69b4;
      color: #fff;
    }

    /* Style for the "Product not found" message */
    .no-products-message {
      width: 100%;
      text-align: center;
      padding: 20px;
      background-color: #ffe4e1;
      border: 1px solid #ddd;
      border-radius: 8px;
      color: #d14792;
      font-size: 16px;
      font-weight: bold;
    }

    /* Mobile filter toggle button */
    .filter-toggle-btn {
      display: none;
      width: 100%;
      padding: 10px;
      background-color: #f8c8dc;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 5px;
      text-align: center;
      margin-bottom: 15px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Media Queries for Responsive Design */
    @media (max-width: 992px) {
      .product-grid {
        width: 100%;
      }

      .product-card {
        width: calc(50% - 10px);
      }

      .sidebar {
        width: 100%;
        margin-bottom: 20px;
      }

      .product-list-container {
        flex-direction: column;
      }

      .filter-toggle-btn {
        display: block;
      }

      .sidebar {
        display: none;
      }

      .sidebar.show {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .shop-topbar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-bar {
        width: 100%;
        justify-content: space-between;
      }

      .search-form {
        max-width: none;
        flex: 1;
      }

      .sort-container {
        align-self: flex-end;
      }

      .product-card {
        width: 100%;
      }

      .clear-button {
        margin-left: 0;
      }

      .price-options {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .pagination {
        flex-wrap: wrap;
      }

      .pagination a {
        margin: 2px;
      }
    }

    @media (max-width: 480px) {
      .main-container {
        padding: 10px;
      }

      .breadcrumb {
        padding: 10px;
        font-size: 12px;
      }

      .search-input {
        font-size: 12px;
      }

      .search-button, .clear-button {
        font-size: 12px;
        padding: 6px 12px;
      }

      .sort-button {
        font-size: 12px;
        padding: 6px 12px;
      }

      .price-button {
        font-size: 12px;
        padding: 8px 15px;
      }
    }
  </style>

  <div class="main-container">
    <section class="shop-page container">
      <div class="breadcrumb-wrap">
        <div class="breadcrumb">
          <a href="/">Home</a>
          <span>></span>
          <span>Shop</span>
        </div>
      </div>
      <div class="shop-topbar">
        <div class="search-bar">
          <form action="/search" method="GET" class="search-form">
            <input type="text" name="query" placeholder="Search items..." class="search-input"
              value="<%= typeof query !== 'undefined' ? query : '' %>" />
            <!-- Add hidden inputs for current filters -->
            <% if (typeof selectedCategory !=='undefined' && selectedCategory) { %>
              <input type="hidden" name="category" value="<%= selectedCategory %>" />
              <% } %>
                <% if (typeof selectedBrand !=='undefined' && selectedBrand) { %>
                  <input type="hidden" name="brand" value="<%= selectedBrand %>" />
                  <% } %>
                    <% if (typeof gt !=='undefined' && gt !==null && typeof lt !=='undefined' && lt !==null) { %>
                      <input type="hidden" name="gt" value="<%= gt %>" />
                      <input type="hidden" name="lt" value="<%= lt %>" />
                      <% } %>
                        <% if (typeof sort !=='undefined' && sort) { %>
                          <input type="hidden" name="sort" value="<%= sort %>" />
                          <% } %>
                            <button type="submit" class="search-button">Search</button>
          </form>
          <button class="clear-button" onclick="window.location.href='/shop'">Clear</button>
        </div>
        <div class="sort-container">
          <form action="/shop" method="GET" id="sort-form">
            <div class="sort-button" id="sort-button">
              Sort by:
              <span class="sort-display">
                <%= sort==='price-low-to-high' ? 'Price: Low to High' : sort==='price-high-to-low'
                  ? 'Price: High to Low' : sort==='a-z' ? 'A-Z' : sort==='z-a' ? 'Z-A' : sort==='new-arrivals'
                  ? 'New Arrivals' : 'Price: High to Low' %>
              </span>
            </div>
            <div class="sort-dropdown" id="sort-dropdown">
              <div class="sort-option" data-value="price-low-to-high">Price: Low to High</div>
              <div class="sort-option" data-value="price-high-to-low">Price: High to Low</div>
              <div class="sort-option" data-value="a-z">A-Z</div>
              <div class="sort-option" data-value="z-a">Z-A</div>
              <div class="sort-option" data-value="new-arrivals">New Arrivals</div>
            </div>
            <select name="sort" id="sort" class="sort-select-hidden">
              <option value="price-low-to-high" <%=sort==='price-low-to-high' ? 'selected' : '' %>>Price: Low to High
              </option>
              <option value="price-high-to-low" <%=sort==='price-high-to-low' ? 'selected' : '' %>>Price: High to Low
              </option>
              <option value="a-z" <%=sort==='a-z' ? 'selected' : '' %>>A-Z</option>
              <option value="z-a" <%=sort==='z-a' ? 'selected' : '' %>>Z-A</option>
              <option value="new-arrivals" <%=sort==='new-arrivals' ? 'selected' : '' %>>New Arrivals</option>
            </select>
          </form>
        </div>
      </div>

      <!-- Mobile filter toggle button -->
      <button class="filter-toggle-btn" id="filter-toggle">Show Filters</button>

      <div class="product-list-container">
        <aside class="sidebar" id="sidebar">
          <div class="filter-section">
            <div class="filter-title">Categories</div>
            <div class="category-brand-container">
              <ul>
                <% for(let i=0; i<category.length; i++) { %>
                  <li class="filter-item">
                    <a href="/filter?category=<%=category[i]._id%>">
                      <%=category[i].name%>
                    </a>
                  </li>
                  <% } %>
              </ul>
            </div>
          </div>

          <div class="filter-section">
            <div class="filter-title">Brands</div>
            <div class="category-brand-container">
              <ul>
                <% for(let i=0; i<brand.length; i++) { %>
                  <li class="filter-item">
                    <a href="/filter?brand=<%=brand[i]%>">
                      <%=brand[i]%>
                    </a>
                  </li>
                  <% } %>
              </ul>
            </div>
          </div>

          <div class="price-filter">
            <div class="filter-title">Filter by Price</div>
            <form id="price-filter-form">
              <div class="price-options">
                <a href="/filterPrice?gt=0&lt=500"><button type="button" class="price-button">Under â‚¹500</button></a>
                <a href="/filterPrice?gt=500&lt=1000"><button type="button" class="price-button">â‚¹500 -
                    â‚¹1000</button></a>
                <a href="/filterPrice?gt=1000&lt=1500"><button type="button" class="price-button">â‚¹1000 -
                    â‚¹1500</button></a>
                <a href="/filterPrice?gt=1500&lt=100000"><button type="button" class="price-button">Above
                    â‚¹1500</button></a>
              </div>
            </form>
          </div>
        </aside>

        <main class="product-grid">
          <% if (productsFound) { %>

            <% for(let i=0; i<products.length; i++) { %>
              <div class="product-card">
                <span class="wishlist-btn" onclick="addToWishlist('<%= products[i]._id %>')"><i
                    class="bi bi-heart-fill"></i></span>
                <a href="/productDetails?id=<%=products[i]._id%>">
                  <img src="<%=products[i].productImage[0]%>" alt="<%=products[i].productName%>" />
                  <h5 title="<%= products[i].productName %>">
                    <%= products[i].productName.length> 20 ? products[i].productName.substring(0, 40) + "..." :
                      products[i].productName %>
                  </h5>
                  <% const
                    discountPercentage=Math.max(products[i].discountPercentage,products[i].category.categoryOffer) 
                    const discount=(products[i].basePrice * discountPercentage) / 100;
                     const discountedPrice=products[i].basePrice - discount; %>

                    <% if (discountPercentage && discountPercentage !==0) { %>
                      <p>
                        Price: â‚¹<%= discountedPrice.toFixed(0) %>
                          <span class="text-muted">
                            <strike>â‚¹<%= products[i].basePrice %></strike>
                          </span>
                          <span style="color: red;">(<%= discountPercentage %>% off)</span>
                      </p>
                      <% } else { %>
                        <p>Price: â‚¹<%= products[i].basePrice %>
                        </p>
                        <% } %>
                </a>
                <button class="add-to-cart-btn" onclick="addToCart('<%= products[i]._id %>',1)">Add to Cart</button>
              </div>
              <% } %>
                <% } else { %>
                  <div class="no-products-message">Product not found</div>
                  <% } %>
        </main>
      </div>

      <!-- PAGINATION SECTION -->
      <div class="pagination">
        <% if (currentPage> 1) { %>
          <% if (typeof query !=='undefined' && query) { %>
            <a class="btn" href="/search?query=<%= query %>&page=<%= currentPage - 1 %>&sort=<%= sort %>">Prev</a>
            <% } else if (typeof selectedCategory !=='undefined' && selectedCategory) { %>
              <a class="btn"
                href="/filter?category=<%= selectedCategory %>&page=<%= currentPage - 1 %>&sort=<%= sort %>">Prev</a>
              <% } else if (typeof selectedBrand !=='undefined' && selectedBrand) { %>
                <a class="btn"
                  href="/filter?brand=<%= selectedBrand %>&page=<%= currentPage - 1 %>&sort=<%= sort %>">Prev</a>
                <% } else if (typeof gt !=='undefined' && typeof lt !=='undefined' ) { %>
                  <a class="btn"
                    href="/filterPrice?gt=<%= gt %>&lt=<%= lt %>&page=<%= currentPage - 1 %>&sort=<%= sort %>">Prev</a>
                  <% } else { %>
                    <a class="btn" href="/shop?page=<%= currentPage - 1 %>&sort=<%= sort %>">Prev</a>
                    <% } %>
                      <% } %>

                        <% for (let i=1; i <=totalPages; i++) { %>
                          <% if (typeof query !=='undefined' && query) { %>
                            <a class="btn <%= currentPage === i ? 'active' : '' %>"
                              href="/search?query=<%= query %>&page=<%= i %>&sort=<%= sort %>">
                              <%= i %>
                            </a>
                            <% } else if (typeof selectedCategory !=='undefined' && selectedCategory) { %>
                              <a class="btn <%= currentPage === i ? 'active' : '' %>"
                                href="/filter?category=<%= selectedCategory %>&page=<%= i %>&sort=<%= sort %>">
                                <%= i %>
                              </a>
                              <% } else if (typeof selectedBrand !=='undefined' && selectedBrand) { %>
                                <a class="btn <%= currentPage === i ? 'active' : '' %>"
                                  href="/filter?brand=<%= selectedBrand %>&page=<%= i %>&sort=<%= sort %>">
                                  <%= i %>
                                </a>
                                <% } else if (typeof gt !=='undefined' && typeof lt !=='undefined' ) { %>
                                  <a class="btn <%= currentPage === i ? 'active' : '' %>"
                                    href="/filterPrice?gt=<%= gt %>&lt=<%= lt %>&page=<%= i %>&sort=<%= sort %>">
                                    <%= i %>
                                  </a>
                                  <% } else { %>
                                    <a class="btn <%= currentPage === i ? 'active' : '' %>"
                                      href="/shop?page=<%= i %>&sort=<%= sort %>">
                                      <%= i %>
                                    </a>
                                    <% } %>
                                      <% } %>

                                        <% if (currentPage < totalPages) { %>
                                          <% if (typeof query !=='undefined' && query) { %>
                                            <a class="btn"
                                              href="/search?query=<%= query %>&page=<%= currentPage + 1 %>&sort=<%= sort %>">Next</a>
                                            <% } else if (typeof selectedCategory !=='undefined' && selectedCategory) {
                                              %>
                                              <a class="btn"
                                                href="/filter?category=<%= selectedCategory %>&page=<%= currentPage + 1 %>&sort=<%= sort %>">Next</a>
                                              <% } else if (typeof selectedBrand !=='undefined' && selectedBrand) { %>
                                                <a class="btn"
                                                  href="/filter?brand=<%= selectedBrand %>&page=<%= currentPage + 1 %>&sort=<%= sort %>">Next</a>
                                                <% } else if (typeof gt !=='undefined' && typeof lt !=='undefined' ) {
                                                  %>
                                                  <a class="btn"
                                                    href="/filterPrice?gt=<%= gt %>&lt=<%= lt %>&page=<%= currentPage + 1 %>&sort=<%= sort %>">Next</a>
                                                  <% } else { %>
                                                    <a class="btn"
                                                      href="/shop?page=<%= currentPage + 1 %>&sort=<%= sort %>">Next</a>
                                                    <% } %>
                                                      <% } %>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const sortButton = document.getElementById('sort-button');
      const sortDropdown = document.getElementById('sort-dropdown');
      const sortOptions = document.querySelectorAll('.sort-option');
      const sortDisplay = document.querySelector('.sort-display');
      const sortForm = document.getElementById('sort-form');
      const sortSelect = document.getElementById('sort');
      const filterToggle = document.getElementById('filter-toggle');
      const sidebar = document.getElementById('sidebar');

      // Filter toggle functionality for mobile
      filterToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
        this.textContent = sidebar.classList.contains('show') ? 'Hide Filters' : 'Show Filters';
      });

      // Get current URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const currentPath = window.location.pathname;

      // Update the sort form action based on the current path
      if (currentPath === '/filter') {
        sortForm.action = '/filter';
        // Preserve existing parameters
        if (urlParams.has('category')) {
          const categoryInput = document.createElement('input');
          categoryInput.type = 'hidden';
          categoryInput.name = 'category';
          categoryInput.value = urlParams.get('category');
          sortForm.appendChild(categoryInput);
        }
        if (urlParams.has('brand')) {
          const brandInput = document.createElement('input');
          brandInput.type = 'hidden';
          brandInput.name = 'brand';
          brandInput.value = urlParams.get('brand');
          sortForm.appendChild(brandInput);
        }
      } else if (currentPath === '/filterPrice') {
        sortForm.action = '/filterPrice';
        // Preserve existing parameters
        if (urlParams.has('gt')) {
          const gtInput = document.createElement('input');
          gtInput.type = 'hidden';
          gtInput.name = 'gt';
          gtInput.value = urlParams.get('gt');
          sortForm.appendChild(gtInput);
        }
        if (urlParams.has('lt')) {
          const ltInput = document.createElement('input');
          ltInput.type = 'hidden';
          ltInput.name = 'lt';
          ltInput.value = urlParams.get('lt');
          sortForm.appendChild(ltInput);
        }
      } else if (currentPath === '/search') {
        sortForm.action = '/search';
        // For search, would need to handle this differently as it's a POST
        // May need to store search query in a hidden field
      }

      sortButton.addEventListener('click', function (e) {
        e.stopPropagation();
        sortDropdown.classList.toggle('show');
      });

      sortOptions.forEach(option => {
        option.addEventListener('click', function () {
          const value = this.getAttribute('data-value');
          const displayText = this.textContent;

          sortDisplay.textContent = displayText;
          sortSelect.value = value;
          sortForm.submit();
          sortDropdown.classList.remove('show');
        });
      });

      document.addEventListener('click', function (e) {
        const sortContainer = e.target.closest('.sort-container');
        if (!sortContainer) {
          sortDropdown.classList.remove('show');
        }
      });
    });

    function addToWishlist(productId) {
      fetch(`/add-to-wishlist?id=${productId}`, {
        method: 'POST'
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.error || err.message);
            });
          }
          return response.json();
        })
        .then(data => {
          Swal.fire({
            icon: 'success',
            title: data.message || 'Added to wishlist',
            timer: 1200,
            showConfirmButton: false,
          });
        })
        .catch(error => {
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: error.message || 'Something went wrong',
            timer: 1200,
            showConfirmButton: false,
          });
        });
    }

     function addToCart(productId, quantity) {
      fetch('/add-to-cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ productId, quantity }),
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => {
              throw new Error(err.message || err.error || 'Something went wrong');
            });
          }
          return response.json();
        })
        .then(data => {
          Swal.fire({
            icon: 'success',
            title: data.message || 'Added to cart!',
            timer: 1200,
            showConfirmButton: false,
          })
        })
        .catch(error => {
          Swal.fire({
            icon: 'error',
            title: 'Oops!',
            text: error.message || 'Failed to add product to cart.',
            timer: 1500,
            showConfirmButton: false,
          });
        });
    }
  </script>

  <%- include("../../views/partials/user/footer.ejs") %>